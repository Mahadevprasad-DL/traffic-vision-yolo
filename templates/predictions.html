<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Traffic Predictions & Live Traffic</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <style>
    /* Navbar Styling */
    .navbar {
      background: rgba(15, 23, 42, 0.9);
      border-bottom: 1px solid rgba(51, 65, 85, 0.8);
      position: sticky;
      top: 0;
      z-index: 50;
      backdrop-filter: blur(8px);
    }

    .nav-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0.75rem 1.5rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .nav-logo {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: white;
      font-weight: 700;
      font-size: 1.25rem;
      letter-spacing: 0.5px;
    }

    .logo-icon {
      font-size: 1.4rem;
    }

    .nav-links {
      list-style: none;
      display: flex;
      gap: 1.8rem;
      margin: 0;
      padding: 0;
    }

    .nav-links li a {
      color: white;
      font-size: 1.05rem;
      font-weight: 600;
      text-decoration: none;
      position: relative;
      transition: color 0.25s ease;
    }

    .nav-links li a:hover {
      color: #f97316;
    }

    .nav-links li.active a {
      color: #f97316;
    }

    .nav-links li.active a::after {
      content: '';
      position: absolute;
      left: 0;
      bottom: -4px;
      width: 100%;
      height: 3px;
      background: linear-gradient(to right, #f97316, #ef4444);
      border-radius: 2px;
    }

    @media (max-width: 768px) {
      .nav-links {
        display: none;
      }
    }

    /* Leaflet Map & Info Box */
    #map {
      height: 500px;
      width: 100%;
      border-radius: 12px;
      margin-top: 2rem;
      z-index: 0;
    }

    #info-panel {
      position: absolute;
      top: 90px;
      right: 40px;
      background: white;
      padding: 16px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.25);
      width: 260px;
      font-size: 14px;
      z-index: 10;
    }

    #info-panel h3 {
      margin-bottom: 6px;
    }

    #error {
      color: red;
      margin-top: 8px;
      font-size: 12px;
    }

    #toggleFlowBtn, #refreshBtn {
      margin-left: 8px;
      padding: 8px 14px;
      border-radius: 6px;
      font-weight: 500;
      cursor: pointer;
    }

    #toggleFlowBtn {
      background-color: #f3f4f6;
    }

    #refreshBtn {
      background-color: #2563eb;
      color: white;
    }
  </style>
</head>

<body class="min-h-screen bg-gradient-to-br from-slate-950 via-slate-900 to-slate-950 py-8">
  <!-- Navbar -->
  <nav class="navbar">
  <div class="nav-container">
    <div class="nav-logo">
      <span class="logo-icon">ðŸš¦</span>
      <span class="logo-text">Urban Traffic Management System</span>
    </div>
    <ul class="nav-links" id="nav-links">

      <li class="{% if request.path == '/' %}active{% endif %}">
        <a href="{{ url_for('index') }}">Home</a>
      </li>

      <li class="{% if '/analytics' in request.path %}active{% endif %}">
        <a href="{{ url_for('analytics') }}">Analytics</a>
      </li>

      <!-- FIXED -->
      <li class="{% if '/detect' in request.path %}active{% endif %}">
        <a href="{{ url_for('detect') }}">Video Analysis</a>
      </li>

      <li class="{% if '/predictions' in request.path %}active{% endif %}">
        <a href="{{ url_for('predictions') }}">Predictions</a>
      </li>

      <li class="{% if '/heatmap' in request.path %}active{% endif %}">
        <a href="{{ url_for('heatmap') }}">Heatmap</a>
      </li>

    </ul>
  </div>
</nav>


  <!-- Page Content -->
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="mb-8 mt-8">
      <h2 class="text-3xl font-bold text-white mb-2">Traffic Predictions</h2>
      <p class="text-slate-400">AI-powered traffic forecasts for better route planning</p>
    </div>

    <!-- Prediction Cards -->
    <div class="grid lg:grid-cols-3 gap-6 mb-8">
      <div class="bg-gradient-to-br from-blue-500/20 to-cyan-500/20 border border-blue-500/30 rounded-xl p-6">
        <div class="flex items-center space-x-3 mb-3">
          <div class="p-2 bg-blue-500 rounded-lg">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 17l6-6 4 4 8-8"/>
            </svg>
          </div>
          <span class="text-sm text-blue-400 font-medium">Prediction Accuracy</span>
        </div>
        <div class="text-3xl font-bold text-white mb-1">94.5%</div>
        <div class="text-xs text-blue-300">Based on historical data</div>
      </div>

      <div class="bg-gradient-to-br from-purple-500/20 to-pink-500/20 border border-purple-500/30 rounded-xl p-6">
        <div class="flex items-center space-x-3 mb-3">
          <div class="p-2 bg-purple-500 rounded-lg">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6l4 2"/>
              <circle cx="12" cy="12" r="9" stroke-width="2" stroke="currentColor" fill="none"/>
            </svg>
          </div>
          <span class="text-sm text-purple-400 font-medium">Update Frequency</span>
        </div>
        <div class="text-3xl font-bold text-white mb-1">Every 5 min</div>
        <div class="text-xs text-purple-300">Real-time updates</div>
      </div>

      <div class="bg-gradient-to-br from-orange-500/20 to-red-500/20 border border-orange-500/30 rounded-xl p-6">
        <div class="flex items-center space-x-3 mb-3">
          <div class="p-2 bg-orange-500 rounded-lg">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
            </svg>
          </div>
          <span class="text-sm text-orange-400 font-medium">Forecast Range</span>
        </div>
        <div class="text-3xl font-bold text-white mb-1">24 Hours</div>
        <div class="text-xs text-orange-300">Advanced predictions</div>
      </div>
    </div>

    <!-- Leaflet Map Section -->
    <div class="relative">
      <div id="map"></div>
      <div id="info-panel">
        <h3><span id="incident-count">0</span> Active Incidents</h3>
        <p>In Bengaluru Area</p>
        <p><strong>Last Updated:</strong> <span id="last-update">--:--</span></p>
        <div id="error"></div>
        <div class="flex justify-end mt-3">
          <button id="toggleFlowBtn">Hide Traffic Flow</button>
          <button id="refreshBtn">Refresh</button>
        </div>
      </div>
    </div>
  </div>

  <!-- JS for TomTom + Map -->
  <script>
    const TOMTOM_API_KEY = "1vo0s7uUAWLbKwsfQY4IherNlc0hpKGk";
    const BENGALURU_CENTER = [12.9716, 77.5946];
    let map, trafficLayer, markers = [], showTrafficFlow = true;

    document.addEventListener("DOMContentLoaded", () => {
      initMap();
      loadTrafficData();
      document.getElementById("toggleFlowBtn").addEventListener("click", toggleTrafficFlow);
      document.getElementById("refreshBtn").addEventListener("click", loadTrafficData);
    });

    function initMap() {
      map = L.map("map").setView(BENGALURU_CENTER, 12);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "Â© OpenStreetMap contributors"
      }).addTo(map);

      trafficLayer = L.tileLayer(
        `https://api.tomtom.com/traffic/map/4/tile/flow/relative/{z}/{x}/{y}.png?key=${TOMTOM_API_KEY}&tileSize=512`,
        { opacity: 0.7, maxZoom: 19 }
      ).addTo(map);
    }

    async function loadTrafficData() {
      const count = document.getElementById("incident-count");
      const time = document.getElementById("last-update");
      const errorBox = document.getElementById("error");

      errorBox.textContent = "";
      count.textContent = "Loading...";

      try {
        const bbox = "77.4500,12.8500,77.7500,13.1000";
        const url = `https://api.tomtom.com/traffic/services/5/incidentDetails?bbox=${bbox}&key=${TOMTOM_API_KEY}&language=en-GB&timeValidityFilter=present`;
        const res = await fetch(url);
        const data = await res.json();

        const incidents = data.incidents || [];
        updateMarkers(incidents);
        count.textContent = incidents.length;
        time.textContent = new Date().toLocaleTimeString();
      } catch (err) {
        errorBox.textContent = "Failed to fetch traffic data.";
        count.textContent = "0";
      }
    }

    function updateMarkers(incidents) {
      markers.forEach(m => map.removeLayer(m));
      markers = [];

      incidents.forEach(incident => {
        if (!incident.geometry?.coordinates?.length) return;
        const [lng, lat] = incident.geometry.coordinates[0];
        const color = getColor(incident.properties?.magnitudeOfDelay || 0);
        const desc = incident.properties?.events?.[0]?.description || "Traffic Incident";

        const marker = L.circleMarker([lat, lng], {
          radius: 8,
          color,
          fillColor: color,
          fillOpacity: 0.8
        }).addTo(map);

        marker.bindPopup(`<strong>${desc}</strong><br>Delay: ${Math.round((incident.properties?.delay || 0) / 60)} min`);
        markers.push(marker);
      });
    }

    function getColor(m) {
      if (m === 0) return "#10b981";
      if (m === 1) return "#eab308";
      if (m === 2) return "#f97316";
      if (m === 3) return "#ef4444";
      return "#dc2626";
    }

    function toggleTrafficFlow() {
      const btn = document.getElementById("toggleFlowBtn");
      if (showTrafficFlow) {
        map.removeLayer(trafficLayer);
        btn.textContent = "Show Traffic Flow";
      } else {
        trafficLayer.addTo(map);
        btn.textContent = "Hide Traffic Flow";
      }
      showTrafficFlow = !showTrafficFlow;
    }
  </script>
</body>
</html>
